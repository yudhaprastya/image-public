name: Daily attendance images â†’ public release assets

on:
  schedule:
    # 09:00 Asia/Jakarta = 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch: {}

permissions:
  contents: write  # create/update release + upload assets

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Download images by date
        env:
          # Base host and path
          BASE_URL: https://storage-media.kejaksaanri.id/absen/upload
          # Choose which variants to grab: "in" or "in,out"
          SUFFIXES: in
          # File extension used by the server
          EXT: png
          # Optional: tweak HTTP behavior
          HTTP_TIMEOUT: "60"
          HTTP_RETRIES: "2"
          # Path to the ids list
          ID_FILE: ids.txt
        run: |
          python download_images_by_date.py

      - name: Create/Update release (tag: daily)
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: daily
          name: Daily Attendance Images
          body: "Latest attendance images (Jakarta date). Includes per-ID latest and dated files."
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload stable "latest" files (overwritten daily)
      - name: Upload latest assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: daily
          file: out/*-latest-*.png
          file_glob: true
          overwrite: true

      # Upload dated copies (history)
      - name: Upload dated assets
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: daily
          file: out/*_*.png
          file_glob: true
          overwrite: true
