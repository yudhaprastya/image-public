name: Daily attendance images - public release assets

on:
  schedule:
    # 09:00 Asia/Jakarta = 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    inputs:
      date_override:
        description: "Test date (YYYY-MM-DD). Leave blank for today's Jakarta date."
        required: false
        default: ""

permissions:
  contents: write  # create/update release + upload assets

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Show inputs
        run: |
          echo "DATE_OVERRIDE='${{ github.event.inputs.date_override }}'"

      - name: Download images by date
        env:
          BASE_URL: "https://storage-media.kejaksaanri.id/absen/upload"
          SUFFIXES: "in"
          EXT: "png"
          HTTP_TIMEOUT: "60"
          HTTP_RETRIES: "2"
          ID_FILE: "ids.txt"
          DATE_OVERRIDE: "${{ github.event.inputs.date_override }}"
        run: |
          set -euxo pipefail
          python download_image.py
          echo "Downloaded files:"
          ls -lh out || true

      - name: "Create or update release (tag: daily)"
        id: release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: daily
          name: "Daily Attendance Images"
          body: "Latest attendance images (Jakarta date). Includes per-ID latest and dated files."
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for latest files
        id: has_latest
        run: |
          shopt -s nullglob
          files=(out/*-latest-*.png)
          echo "Found ${#files[@]} latest files"
          if [ ${#files[@]} -gt 0 ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload latest assets
        if: steps.has_latest.outputs.present == 'true'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: daily
          file: "out/*-latest-*.png"
          file_glob: true
          overwrite: true

      - name: Check for dated files
        id: has_dated
        run: |
          shopt -s nullglob
          files=(out/*_*.png)
          echo "Found ${#files[@]} dated files"
          if [ ${#files[@]} -gt 0 ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload dated assets
        if: steps.has_dated.outputs.present == 'true'
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          tag: daily
          file: "out/*_*.png"
          file_glob: true
          overwrite: true
